<!DOCTYPE html>
<HTML lang = "en">
<HEAD>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Calibration error estimates and p-value approximations for modern neural networks</title>
  

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: { equationNumbers: { autoNumber: "AMS" } }
    });
  </script>

  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  
<style>
pre.hljl {
    border: 1px solid #ccc;
    margin: 5px;
    padding: 5px;
    overflow-x: auto;
    color: rgb(68,68,68); background-color: rgb(251,251,251); }
pre.hljl > span.hljl-t { }
pre.hljl > span.hljl-w { }
pre.hljl > span.hljl-e { }
pre.hljl > span.hljl-eB { }
pre.hljl > span.hljl-o { }
pre.hljl > span.hljl-k { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kc { color: rgb(59,151,46); font-style: italic; }
pre.hljl > span.hljl-kd { color: rgb(214,102,97); font-style: italic; }
pre.hljl > span.hljl-kn { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kp { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kr { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kt { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-n { }
pre.hljl > span.hljl-na { }
pre.hljl > span.hljl-nb { }
pre.hljl > span.hljl-nbp { }
pre.hljl > span.hljl-nc { }
pre.hljl > span.hljl-ncB { }
pre.hljl > span.hljl-nd { color: rgb(214,102,97); }
pre.hljl > span.hljl-ne { }
pre.hljl > span.hljl-neB { }
pre.hljl > span.hljl-nf { color: rgb(66,102,213); }
pre.hljl > span.hljl-nfm { color: rgb(66,102,213); }
pre.hljl > span.hljl-np { }
pre.hljl > span.hljl-nl { }
pre.hljl > span.hljl-nn { }
pre.hljl > span.hljl-no { }
pre.hljl > span.hljl-nt { }
pre.hljl > span.hljl-nv { }
pre.hljl > span.hljl-nvc { }
pre.hljl > span.hljl-nvg { }
pre.hljl > span.hljl-nvi { }
pre.hljl > span.hljl-nvm { }
pre.hljl > span.hljl-l { }
pre.hljl > span.hljl-ld { color: rgb(148,91,176); font-style: italic; }
pre.hljl > span.hljl-s { color: rgb(201,61,57); }
pre.hljl > span.hljl-sa { color: rgb(201,61,57); }
pre.hljl > span.hljl-sb { color: rgb(201,61,57); }
pre.hljl > span.hljl-sc { color: rgb(201,61,57); }
pre.hljl > span.hljl-sd { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdB { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdC { color: rgb(201,61,57); }
pre.hljl > span.hljl-se { color: rgb(59,151,46); }
pre.hljl > span.hljl-sh { color: rgb(201,61,57); }
pre.hljl > span.hljl-si { }
pre.hljl > span.hljl-so { color: rgb(201,61,57); }
pre.hljl > span.hljl-sr { color: rgb(201,61,57); }
pre.hljl > span.hljl-ss { color: rgb(201,61,57); }
pre.hljl > span.hljl-ssB { color: rgb(201,61,57); }
pre.hljl > span.hljl-nB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nbB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nfB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nh { color: rgb(59,151,46); }
pre.hljl > span.hljl-ni { color: rgb(59,151,46); }
pre.hljl > span.hljl-nil { color: rgb(59,151,46); }
pre.hljl > span.hljl-noB { color: rgb(59,151,46); }
pre.hljl > span.hljl-oB { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-ow { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-p { }
pre.hljl > span.hljl-c { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-ch { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cm { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cp { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cpB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cs { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-csB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-g { }
pre.hljl > span.hljl-gd { }
pre.hljl > span.hljl-ge { }
pre.hljl > span.hljl-geB { }
pre.hljl > span.hljl-gh { }
pre.hljl > span.hljl-gi { }
pre.hljl > span.hljl-go { }
pre.hljl > span.hljl-gp { }
pre.hljl > span.hljl-gs { }
pre.hljl > span.hljl-gsB { }
pre.hljl > span.hljl-gt { }
</style>



  <style type="text/css">
  @font-face {
  font-style: normal;
  font-weight: 300;
}
@font-face {
  font-style: normal;
  font-weight: 400;
}
@font-face {
  font-style: normal;
  font-weight: 600;
}
html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}
body {
  margin: 0;
}
article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
menu,
nav,
section,
summary {
  display: block;
}
audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}
audio:not([controls]) {
  display: none;
  height: 0;
}
[hidden],
template {
  display: none;
}
a:active,
a:hover {
  outline: 0;
}
abbr[title] {
  border-bottom: 1px dotted;
}
b,
strong {
  font-weight: bold;
}
dfn {
  font-style: italic;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
mark {
  background: #ff0;
  color: #000;
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 1em 40px;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
pre {
  overflow: auto;
}
code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}
button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}
button {
  overflow: visible;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}
button[disabled],
html input[disabled] {
  cursor: default;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
input {
  line-height: normal;
}
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}
input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box; /* 2 */
  box-sizing: content-box;
}
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}
textarea {
  overflow: auto;
}
optgroup {
  font-weight: bold;
}
table {
  font-family: monospace, monospace;
  font-size : 0.8em;
  border-collapse: collapse;
  border-spacing: 0;
}
td,
th {
  padding: 0;
}
thead th {
    border-bottom: 1px solid black;
    background-color: white;
}
tr:nth-child(odd){
  background-color: rgb(248,248,248);
}


/*
* Skeleton V2.0.4
* Copyright 2014, Dave Gamache
* www.getskeleton.com
* Free to use under the MIT license.
* http://www.opensource.org/licenses/mit-license.php
* 12/29/2014
*/
.container {
  position: relative;
  width: 100%;
  max-width: 960px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box; }
.column,
.columns {
  width: 100%;
  float: left;
  box-sizing: border-box; }
@media (min-width: 400px) {
  .container {
    width: 85%;
    padding: 0; }
}
@media (min-width: 550px) {
  .container {
    width: 80%; }
  .column,
  .columns {
    margin-left: 4%; }
  .column:first-child,
  .columns:first-child {
    margin-left: 0; }

  .one.column,
  .one.columns                    { width: 4.66666666667%; }
  .two.columns                    { width: 13.3333333333%; }
  .three.columns                  { width: 22%;            }
  .four.columns                   { width: 30.6666666667%; }
  .five.columns                   { width: 39.3333333333%; }
  .six.columns                    { width: 48%;            }
  .seven.columns                  { width: 56.6666666667%; }
  .eight.columns                  { width: 65.3333333333%; }
  .nine.columns                   { width: 74.0%;          }
  .ten.columns                    { width: 82.6666666667%; }
  .eleven.columns                 { width: 91.3333333333%; }
  .twelve.columns                 { width: 100%; margin-left: 0; }

  .one-third.column               { width: 30.6666666667%; }
  .two-thirds.column              { width: 65.3333333333%; }

  .one-half.column                { width: 48%; }

  /* Offsets */
  .offset-by-one.column,
  .offset-by-one.columns          { margin-left: 8.66666666667%; }
  .offset-by-two.column,
  .offset-by-two.columns          { margin-left: 17.3333333333%; }
  .offset-by-three.column,
  .offset-by-three.columns        { margin-left: 26%;            }
  .offset-by-four.column,
  .offset-by-four.columns         { margin-left: 34.6666666667%; }
  .offset-by-five.column,
  .offset-by-five.columns         { margin-left: 43.3333333333%; }
  .offset-by-six.column,
  .offset-by-six.columns          { margin-left: 52%;            }
  .offset-by-seven.column,
  .offset-by-seven.columns        { margin-left: 60.6666666667%; }
  .offset-by-eight.column,
  .offset-by-eight.columns        { margin-left: 69.3333333333%; }
  .offset-by-nine.column,
  .offset-by-nine.columns         { margin-left: 78.0%;          }
  .offset-by-ten.column,
  .offset-by-ten.columns          { margin-left: 86.6666666667%; }
  .offset-by-eleven.column,
  .offset-by-eleven.columns       { margin-left: 95.3333333333%; }

  .offset-by-one-third.column,
  .offset-by-one-third.columns    { margin-left: 34.6666666667%; }
  .offset-by-two-thirds.column,
  .offset-by-two-thirds.columns   { margin-left: 69.3333333333%; }

  .offset-by-one-half.column,
  .offset-by-one-half.columns     { margin-left: 52%; }

}
html {
  font-size: 62.5%; }
body {
  font-size: 1.5em; /* currently ems cause chrome bug misinterpreting rems on body element */
  line-height: 1.6;
  font-weight: 400;
  font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
  color: #222; }
h1, h2, h3, h4, h5, h6 {
  margin-top: 0;
  margin-bottom: 2rem;
  font-weight: 300; }
h1 { font-size: 3.6rem; line-height: 1.2;  letter-spacing: -.1rem;}
h2 { font-size: 3.4rem; line-height: 1.25; letter-spacing: -.1rem; }
h3 { font-size: 3.2rem; line-height: 1.3;  letter-spacing: -.1rem; }
h4 { font-size: 2.8rem; line-height: 1.35; letter-spacing: -.08rem; }
h5 { font-size: 2.4rem; line-height: 1.5;  letter-spacing: -.05rem; }
h6 { font-size: 1.5rem; line-height: 1.6;  letter-spacing: 0; }

p {
  margin-top: 0; }
a {
  color: #1EAEDB; }
a:hover {
  color: #0FA0CE; }
.button,
button,
input[type="submit"],
input[type="reset"],
input[type="button"] {
  display: inline-block;
  height: 38px;
  padding: 0 30px;
  color: #555;
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  line-height: 38px;
  letter-spacing: .1rem;
  text-transform: uppercase;
  text-decoration: none;
  white-space: nowrap;
  background-color: transparent;
  border-radius: 4px;
  border: 1px solid #bbb;
  cursor: pointer;
  box-sizing: border-box; }
.button:hover,
button:hover,
input[type="submit"]:hover,
input[type="reset"]:hover,
input[type="button"]:hover,
.button:focus,
button:focus,
input[type="submit"]:focus,
input[type="reset"]:focus,
input[type="button"]:focus {
  color: #333;
  border-color: #888;
  outline: 0; }
.button.button-primary,
button.button-primary,
input[type="submit"].button-primary,
input[type="reset"].button-primary,
input[type="button"].button-primary {
  color: #FFF;
  background-color: #33C3F0;
  border-color: #33C3F0; }
.button.button-primary:hover,
button.button-primary:hover,
input[type="submit"].button-primary:hover,
input[type="reset"].button-primary:hover,
input[type="button"].button-primary:hover,
.button.button-primary:focus,
button.button-primary:focus,
input[type="submit"].button-primary:focus,
input[type="reset"].button-primary:focus,
input[type="button"].button-primary:focus {
  color: #FFF;
  background-color: #1EAEDB;
  border-color: #1EAEDB; }
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea,
select {
  height: 38px;
  padding: 6px 10px; /* The 6px vertically centers text on FF, ignored by Webkit */
  background-color: #fff;
  border: 1px solid #D1D1D1;
  border-radius: 4px;
  box-shadow: none;
  box-sizing: border-box; }
/* Removes awkward default styles on some inputs for iOS */
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea {
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none; }
textarea {
  min-height: 65px;
  padding-top: 6px;
  padding-bottom: 6px; }
input[type="email"]:focus,
input[type="number"]:focus,
input[type="search"]:focus,
input[type="text"]:focus,
input[type="tel"]:focus,
input[type="url"]:focus,
input[type="password"]:focus,
textarea:focus,
select:focus {
  border: 1px solid #33C3F0;
  outline: 0; }
label,
legend {
  display: block;
  margin-bottom: .5rem;
  font-weight: 600; }
fieldset {
  padding: 0;
  border-width: 0; }
input[type="checkbox"],
input[type="radio"] {
  display: inline; }
label > .label-body {
  display: inline-block;
  margin-left: .5rem;
  font-weight: normal; }
ul {
  list-style: circle; }
ol {
  list-style: decimal; }
ul ul,
ul ol,
ol ol,
ol ul {
  margin: 1.5rem 0 1.5rem 3rem;
  font-size: 90%; }
li > p {margin : 0;}
th,
td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #E1E1E1; }
th:first-child,
td:first-child {
  padding-left: 0; }
th:last-child,
td:last-child {
  padding-right: 0; }
button,
.button {
  margin-bottom: 1rem; }
input,
textarea,
select,
fieldset {
  margin-bottom: 1.5rem; }
pre,
blockquote,
dl,
figure,
table,
p,
ul,
ol,
form {
  margin-bottom: 1.0rem; }
.u-full-width {
  width: 100%;
  box-sizing: border-box; }
.u-max-full-width {
  max-width: 100%;
  box-sizing: border-box; }
.u-pull-right {
  float: right; }
.u-pull-left {
  float: left; }
hr {
  margin-top: 3rem;
  margin-bottom: 3.5rem;
  border-width: 0;
  border-top: 1px solid #E1E1E1; }
.container:after,
.row:after,
.u-cf {
  content: "";
  display: table;
  clear: both; }

pre {
  display: block;
  padding: 9.5px;
  margin: 0 0 10px;
  font-size: 13px;
  line-height: 1.42857143;
  word-break: break-all;
  word-wrap: break-word;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre.hljl {
  margin: 0 0 10px;
  display: block;
  background: #f5f5f5;
  border-radius: 4px;
  padding : 5px;
}

pre.output {
  background: #ffffff;
}

pre.code {
  background: #ffffff;
}

pre.julia-error {
  color : red
}

code,
kbd,
pre,
samp {
  font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
  font-size: 13px;
}


@media (min-width: 400px) {}
@media (min-width: 550px) {}
@media (min-width: 750px) {}
@media (min-width: 1000px) {}
@media (min-width: 1200px) {}

h1.title {margin-top : 20px}
img {max-width : 100%}
div.title {text-align: center;}

  </style>



</HEAD>
  <BODY>
    <div class ="container">
      <div class = "row">
        <div class = "col-md-12 twelve columns">

          <div class="title">
            <h1 class="title">Calibration error estimates and p-value approximations for modern neural networks</h1>
            <h5>David Widmann</h5>
            
          </div>

          
<h1>Intro</h1>
<p>In the following experiments we download a set of pretrained modern neural networks for the image data set CIFAR-10. We estimate the expected calibration error &#40;ECE&#41; with respect to the total variation distance and the squared kernel calibration error of these models.</p>

<h1>Packages</h1>
<p>We perform distributed computing to speed up our computations.</p>


<pre class='hljl'>
<span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>Distributed</span>
</pre>



<p>First we have to activate the local package environment on all cores.</p>


<pre class='hljl'>
<span class='hljl-nd'>@everywhere</span><span class='hljl-t'> </span><span class='hljl-k'>begin</span><span class='hljl-t'>
    </span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>Pkg</span><span class='hljl-t'>
    </span><span class='hljl-n'>Pkg</span><span class='hljl-oB'>.</span><span class='hljl-nf'>activate</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-nd'>@__DIR__</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;..&quot;</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<pre class="output">
Activating environment at &#96;~/Projects/julia/CalibrationPaper/experiments/Pr
oject.toml&#96;
</pre>


<p>Then we load the packages that are required on all cores.</p>


<pre class='hljl'>
<span class='hljl-nd'>@everywhere</span><span class='hljl-t'> </span><span class='hljl-k'>begin</span><span class='hljl-t'>
    </span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>CalibrationErrors</span><span class='hljl-t'>
    </span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>CalibrationPaper</span><span class='hljl-t'>
    </span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>CalibrationTests</span><span class='hljl-t'>

    </span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>DelimitedFiles</span><span class='hljl-t'>
    </span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>Random</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>The following packages are only required on the main process.</p>


<pre class='hljl'>
<span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>Conda</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>CSV</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>DataDeps</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>DataFrames</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>PyCall</span><span class='hljl-t'>

</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>LibGit2</span>
</pre>



<h1>Experiments</h1>
<h2>Pretrained neural networks</h2>
<p>As a first step we download a set of pretrained neural networks for CIFAR-10 from <a href="https://github.com/huyvnphan/PyTorch-CIFAR10">PyTorch-CIFAR10</a>. We extract the predictions of these models on the validation data set together with the correct labels.</p>
<p>We start by registering the required data. If you want to rerun this experiment from scratch, please download the pretrained weights of the models.</p>


<pre class='hljl'>
<span class='hljl-nf'>register</span><span class='hljl-p'>(</span><span class='hljl-nf'>ManualDataDep</span><span class='hljl-p'>(</span><span class='hljl-t'>
    </span><span class='hljl-s'>&quot;PyTorch-CIFAR10&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-s'>&quot;&quot;&quot;
    Please go to
        https://drive.google.com/drive/folders/15jBlLkOFg0eK-pwsmXoSesNDyDb_HOeV
    and download the pretrained weights.
    Note that this must be done manually since Google requires to confirm the download of
    large files and I have not automated the confirmation process (yet).
    &quot;&quot;&quot;</span><span class='hljl-t'>
</span><span class='hljl-p'>))</span>
</pre>


<pre class="output">
DataDeps.ManualDataDep&#40;&quot;PyTorch-CIFAR10&quot;, &quot;Please go to\n    https://drive.
google.com/drive/folders/15jBlLkOFg0eK-pwsmXoSesNDyDb_HOeV\nand download th
e pretrained weights.\nNote that this must be done manually since Google re
quires to confirm the download of\nlarge files and I have not automated the
 confirmation process &#40;yet&#41;.\n&quot;&#41;
</pre>


<p>First we install PyTorch.</p>


<pre class='hljl'>
<span class='hljl-n'>Conda</span><span class='hljl-oB'>.</span><span class='hljl-nf'>add</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;cpuonly=1.0&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>channel</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;pytorch&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Collecting package metadata &#40;current_repodata.json&#41;: ...working... done
Solving environment: ...working... done

# All requested packages already installed.
</pre>



<pre class='hljl'>
<span class='hljl-n'>Conda</span><span class='hljl-oB'>.</span><span class='hljl-nf'>add</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;pytorch=1.3.0&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>channel</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;pytorch&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Collecting package metadata &#40;current_repodata.json&#41;: ...working... done
Solving environment: ...working... done

# All requested packages already installed.
</pre>



<pre class='hljl'>
<span class='hljl-n'>Conda</span><span class='hljl-oB'>.</span><span class='hljl-nf'>add</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;torchvision=0.4.1&quot;</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>channel</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;pytorch&quot;</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Collecting package metadata &#40;current_repodata.json&#41;: ...working... done
Solving environment: ...working... done

# All requested packages already installed.
</pre>



<pre class='hljl'>
<span class='hljl-nf'>mktempdir</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-k'>do</span><span class='hljl-t'> </span><span class='hljl-n'>dir</span><span class='hljl-t'>
    </span><span class='hljl-cs'># create directory for results</span><span class='hljl-t'>
    </span><span class='hljl-n'>datadir</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-nd'>@__DIR__</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;..&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;data&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;PyTorch-CIFAR10&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>isdir</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>||</span><span class='hljl-t'> </span><span class='hljl-nf'>mkpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># check if predictions exist</span><span class='hljl-t'>
    </span><span class='hljl-n'>modelnames</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;densenet121&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;densenet161&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;densenet169&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;googlenet&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;inception_v3&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
                  </span><span class='hljl-s'>&quot;mobilenet_v2&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet_orig&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet18&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet34&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet50&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
                  </span><span class='hljl-s'>&quot;vgg11_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg13_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg16_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg19_bn&quot;</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-k'>let</span><span class='hljl-t'> </span><span class='hljl-n'>datadir</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>datadir</span><span class='hljl-t'>
        </span><span class='hljl-nf'>filter!</span><span class='hljl-p'>(</span><span class='hljl-n'>modelnames</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-k'>do</span><span class='hljl-t'> </span><span class='hljl-n'>name</span><span class='hljl-t'>
            </span><span class='hljl-oB'>!</span><span class='hljl-nf'>isfile</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;</span><span class='hljl-si'>$name</span><span class='hljl-s'>.csv&quot;</span><span class='hljl-p'>))</span><span class='hljl-t'>
        </span><span class='hljl-k'>end</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-cs'># exit if predictions and labels exist</span><span class='hljl-t'>
    </span><span class='hljl-nf'>isempty</span><span class='hljl-p'>(</span><span class='hljl-n'>modelnames</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>&amp;&amp;</span><span class='hljl-t'> </span><span class='hljl-nf'>isfile</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;labels.csv&quot;</span><span class='hljl-p'>))</span><span class='hljl-t'> </span><span class='hljl-oB'>&amp;&amp;</span><span class='hljl-t'> </span><span class='hljl-k'>return</span><span class='hljl-t'>

    </span><span class='hljl-cs'># clone repository</span><span class='hljl-t'>
    </span><span class='hljl-n'>repodir</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>mkdir</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>dir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;PyTorch-CIFAR10&quot;</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-n'>LibGit2</span><span class='hljl-oB'>.</span><span class='hljl-nf'>clone</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;https://github.com/huyvnphan/PyTorch-CIFAR10.git&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>repodir</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>LibGit2</span><span class='hljl-oB'>.</span><span class='hljl-nf'>checkout!</span><span class='hljl-p'>(</span><span class='hljl-n'>LibGit2</span><span class='hljl-oB'>.</span><span class='hljl-nf'>GitRepo</span><span class='hljl-p'>(</span><span class='hljl-n'>repodir</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;90325333f4da099b3a795693cfa18e64490dffe9&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># copy pretrained weights to the correct directory</span><span class='hljl-t'>
    </span><span class='hljl-n'>weightsdir</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>repodir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;models&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;state_dicts&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>name</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>modelnames</span><span class='hljl-t'>
        </span><span class='hljl-nf'>cp</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-so'>datadep&quot;PyTorch-CIFAR10&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;</span><span class='hljl-si'>$name</span><span class='hljl-s'>.pt&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>weightsdir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;</span><span class='hljl-si'>$name</span><span class='hljl-s'>.pt&quot;</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-cs'># load Python packages</span><span class='hljl-t'>
    </span><span class='hljl-n'>torch</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pyimport</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;torch&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>F</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pyimport</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;torch.nn.functional&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>torchvision</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pyimport</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;torchvision&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>transforms</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pyimport</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;torchvision.transforms&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># import local models</span><span class='hljl-t'>
    </span><span class='hljl-nf'>pushfirst!</span><span class='hljl-p'>(</span><span class='hljl-nf'>PyVector</span><span class='hljl-p'>(</span><span class='hljl-nf'>pyimport</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;sys&quot;</span><span class='hljl-p'>)</span><span class='hljl-oB'>.</span><span class='hljl-s'>&quot;path&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>repodir</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>models</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pyimport</span><span class='hljl-p'>(</span><span class='hljl-s'>&quot;models&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># define transformation</span><span class='hljl-t'>
    </span><span class='hljl-n'>transform</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>transforms</span><span class='hljl-oB'>.</span><span class='hljl-nf'>Compose</span><span class='hljl-p'>([</span><span class='hljl-n'>transforms</span><span class='hljl-oB'>.</span><span class='hljl-nf'>ToTensor</span><span class='hljl-p'>(),</span><span class='hljl-t'>
                                    </span><span class='hljl-n'>transforms</span><span class='hljl-oB'>.</span><span class='hljl-nf'>Normalize</span><span class='hljl-p'>([</span><span class='hljl-nfB'>0.4914</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.4822</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.4465</span><span class='hljl-p'>],</span><span class='hljl-t'>
                                                         </span><span class='hljl-p'>[</span><span class='hljl-nfB'>0.2023</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.1994</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.2010</span><span class='hljl-p'>])])</span><span class='hljl-t'>

    </span><span class='hljl-cs'># download CIFAR-10 validation data set</span><span class='hljl-t'>
    </span><span class='hljl-n'>dataset</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>torchvision</span><span class='hljl-oB'>.</span><span class='hljl-n'>datasets</span><span class='hljl-oB'>.</span><span class='hljl-nf'>CIFAR10</span><span class='hljl-p'>(</span><span class='hljl-n'>root</span><span class='hljl-oB'>=</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>dir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;CIFAR10&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>train</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>,</span><span class='hljl-t'>
                                           </span><span class='hljl-n'>transform</span><span class='hljl-oB'>=</span><span class='hljl-n'>transform</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>download</span><span class='hljl-oB'>=</span><span class='hljl-kc'>true</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># extract and save labels</span><span class='hljl-t'>
    </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-oB'>!</span><span class='hljl-nf'>isfile</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;labels.csv&quot;</span><span class='hljl-p'>))</span><span class='hljl-t'>
        </span><span class='hljl-nd'>@info</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;extracting labels...&quot;</span><span class='hljl-t'>

        </span><span class='hljl-cs'># extract labels of the validation data set</span><span class='hljl-t'>
        </span><span class='hljl-n'>_</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>labels_py</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>iterate</span><span class='hljl-p'>(</span><span class='hljl-n'>torch</span><span class='hljl-oB'>.</span><span class='hljl-n'>utils</span><span class='hljl-oB'>.</span><span class='hljl-n'>data</span><span class='hljl-oB'>.</span><span class='hljl-nf'>DataLoader</span><span class='hljl-p'>(</span><span class='hljl-n'>dataset</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>batch_size</span><span class='hljl-oB'>=</span><span class='hljl-ni'>10_000</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>shuffle</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>))[</span><span class='hljl-ni'>1</span><span class='hljl-p'>]</span><span class='hljl-t'>

        </span><span class='hljl-cs'># save labels (+1 since we need classes 1,...,n)</span><span class='hljl-t'>
        </span><span class='hljl-n'>labels</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pycall</span><span class='hljl-p'>(</span><span class='hljl-n'>labels_py</span><span class='hljl-oB'>.</span><span class='hljl-s'>&quot;numpy&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>PyArray</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>.+</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-t'>
        </span><span class='hljl-nf'>writedlm</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;labels.csv&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>labels</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-cs'># extract predictions</span><span class='hljl-t'>
    </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-oB'>!</span><span class='hljl-nf'>isempty</span><span class='hljl-p'>(</span><span class='hljl-n'>modelnames</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-cs'># create data loader with batches of 250 images</span><span class='hljl-t'>
        </span><span class='hljl-n'>dataloader</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>torch</span><span class='hljl-oB'>.</span><span class='hljl-n'>utils</span><span class='hljl-oB'>.</span><span class='hljl-n'>data</span><span class='hljl-oB'>.</span><span class='hljl-nf'>DataLoader</span><span class='hljl-p'>(</span><span class='hljl-n'>dataset</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>batch_size</span><span class='hljl-oB'>=</span><span class='hljl-ni'>250</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>shuffle</span><span class='hljl-oB'>=</span><span class='hljl-kc'>false</span><span class='hljl-p'>)</span><span class='hljl-t'>

        </span><span class='hljl-nf'>cd</span><span class='hljl-p'>(</span><span class='hljl-n'>repodir</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-k'>do</span><span class='hljl-t'>
            </span><span class='hljl-nd'>@pywith</span><span class='hljl-t'> </span><span class='hljl-n'>torch</span><span class='hljl-oB'>.</span><span class='hljl-nf'>no_grad</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-k'>begin</span><span class='hljl-t'>
                </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>name</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>modelnames</span><span class='hljl-t'>
                    </span><span class='hljl-nd'>@info</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;extracting predictions of model </span><span class='hljl-si'>$name</span><span class='hljl-s'>...&quot;</span><span class='hljl-t'>

                    </span><span class='hljl-cs'># load model with pretrained weights</span><span class='hljl-t'>
                    </span><span class='hljl-n'>model</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>getproperty</span><span class='hljl-p'>(</span><span class='hljl-n'>models</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>name</span><span class='hljl-p'>)(</span><span class='hljl-n'>pretrained</span><span class='hljl-oB'>=</span><span class='hljl-kc'>true</span><span class='hljl-p'>)</span><span class='hljl-t'>

                    </span><span class='hljl-cs'># save all predictions</span><span class='hljl-t'>
                    </span><span class='hljl-nf'>open</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;</span><span class='hljl-si'>$name</span><span class='hljl-s'>.csv&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;w&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-k'>do</span><span class='hljl-t'> </span><span class='hljl-n'>f</span><span class='hljl-t'>
                        </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>images_py</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>_</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>dataloader</span><span class='hljl-t'>
                            </span><span class='hljl-n'>predictions</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pycall</span><span class='hljl-p'>(</span><span class='hljl-n'>F</span><span class='hljl-oB'>.</span><span class='hljl-nf'>softmax</span><span class='hljl-p'>(</span><span class='hljl-nf'>model</span><span class='hljl-p'>(</span><span class='hljl-n'>images_py</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>dim</span><span class='hljl-oB'>=</span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-oB'>.</span><span class='hljl-s'>&quot;numpy&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>PyArray</span><span class='hljl-p'>)</span><span class='hljl-t'>
                            </span><span class='hljl-nf'>writedlm</span><span class='hljl-p'>(</span><span class='hljl-n'>f</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>predictions</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>&#39;,&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>
                        </span><span class='hljl-k'>end</span><span class='hljl-t'>
                    </span><span class='hljl-k'>end</span><span class='hljl-t'>
                </span><span class='hljl-k'>end</span><span class='hljl-t'>
            </span><span class='hljl-k'>end</span><span class='hljl-t'>
        </span><span class='hljl-k'>end</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-n'>nothing</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<h2>Calibration error estimates</h2>
<p>For all pretrained neural networks we compute a set of different calibration error estimates and save them in a CSV file <code>errors.csv</code>. More concretely, we evaluate the expected calibration error estimators with 10 uniform bins per dimension and with data dependent bins, and the biased and the unbiased quadratic estimator of the squared kernel calibration error as well as the unbiased linear estimator for a uniformly scaled exponential kernel for which the bandwidth is set with the median heuristic.</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>calibration_errors</span><span class='hljl-p'>()</span><span class='hljl-t'>
    </span><span class='hljl-cs'># do not recompute the calibration errors if a file with results exists</span><span class='hljl-t'>
    </span><span class='hljl-n'>datadir</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-nd'>@__DIR__</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;..&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;data&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;PyTorch-CIFAR10&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>file</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;errors.csv&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>isfile</span><span class='hljl-p'>(</span><span class='hljl-n'>file</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>&amp;&amp;</span><span class='hljl-t'> </span><span class='hljl-k'>return</span><span class='hljl-t'>

    </span><span class='hljl-cs'># load labels</span><span class='hljl-t'>
    </span><span class='hljl-n'>labels</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vec</span><span class='hljl-p'>(</span><span class='hljl-nf'>readdlm</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;labels.csv&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-sc'>&#39;,&#39;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Int</span><span class='hljl-p'>))</span><span class='hljl-t'>

    </span><span class='hljl-cs'># define the studied models</span><span class='hljl-t'>
    </span><span class='hljl-n'>models</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;densenet121&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;densenet161&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;densenet169&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;googlenet&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;inception_v3&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
              </span><span class='hljl-s'>&quot;mobilenet_v2&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet_orig&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet18&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet34&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet50&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
              </span><span class='hljl-s'>&quot;vgg11_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg13_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg16_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg19_bn&quot;</span><span class='hljl-p'>]</span><span class='hljl-t'>

    </span><span class='hljl-cs'># define arrays for the estimates</span><span class='hljl-t'>
    </span><span class='hljl-n'>n</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>length</span><span class='hljl-p'>(</span><span class='hljl-n'>models</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>ece_uniform</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}(</span><span class='hljl-n'>undef</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>ece_dynamic</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}(</span><span class='hljl-n'>undef</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceb_median</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}(</span><span class='hljl-n'>undef</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceuq_median</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}(</span><span class='hljl-n'>undef</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceul_median</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Vector</span><span class='hljl-p'>{</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}(</span><span class='hljl-n'>undef</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>n</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># analyze every model</span><span class='hljl-t'>
    </span><span class='hljl-nd'>@inbounds</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>i</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-oB'>:</span><span class='hljl-n'>n</span><span class='hljl-t'>
        </span><span class='hljl-n'>model</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>models</span><span class='hljl-p'>[</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'>
        </span><span class='hljl-nd'>@info</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;evaluating calibration error estimators for </span><span class='hljl-si'>$model</span><span class='hljl-s'>...&quot;</span><span class='hljl-t'>

        </span><span class='hljl-cs'># load predictions</span><span class='hljl-t'>
        </span><span class='hljl-n'>predictions</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>copy</span><span class='hljl-p'>(</span><span class='hljl-nf'>readdlm</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;</span><span class='hljl-si'>$model</span><span class='hljl-s'>.csv&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-sc'>&#39;,&#39;</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-n'>data</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>predictions</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>labels</span><span class='hljl-p'>)</span><span class='hljl-t'>

        </span><span class='hljl-cs'># evaluate ECE estimators</span><span class='hljl-t'>
        </span><span class='hljl-n'>ece_uniform</span><span class='hljl-p'>[</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>calibrationerror</span><span class='hljl-p'>(</span><span class='hljl-nf'>ECE</span><span class='hljl-p'>(</span><span class='hljl-nf'>UniformBinning</span><span class='hljl-p'>(</span><span class='hljl-ni'>10</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-n'>ece_dynamic</span><span class='hljl-p'>[</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>calibrationerror</span><span class='hljl-p'>(</span><span class='hljl-nf'>ECE</span><span class='hljl-p'>(</span><span class='hljl-nf'>MedianVarianceBinning</span><span class='hljl-p'>(</span><span class='hljl-ni'>10</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-t'>

        </span><span class='hljl-cs'># compute kernel based on the median heuristic</span><span class='hljl-t'>
        </span><span class='hljl-n'>kernel</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>median_TV_kernel</span><span class='hljl-p'>(</span><span class='hljl-n'>predictions</span><span class='hljl-p'>)</span><span class='hljl-t'>

        </span><span class='hljl-cs'># evaluate SKCE estimators</span><span class='hljl-t'>
        </span><span class='hljl-n'>skceb_median</span><span class='hljl-p'>[</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>calibrationerror</span><span class='hljl-p'>(</span><span class='hljl-nf'>BiasedSKCE</span><span class='hljl-p'>(</span><span class='hljl-n'>kernel</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-n'>skceuq_median</span><span class='hljl-p'>[</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>calibrationerror</span><span class='hljl-p'>(</span><span class='hljl-nf'>QuadraticUnbiasedSKCE</span><span class='hljl-p'>(</span><span class='hljl-n'>kernel</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-n'>skceul_median</span><span class='hljl-p'>[</span><span class='hljl-n'>i</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>calibrationerror</span><span class='hljl-p'>(</span><span class='hljl-nf'>LinearUnbiasedSKCE</span><span class='hljl-p'>(</span><span class='hljl-n'>kernel</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-cs'># save results</span><span class='hljl-t'>
    </span><span class='hljl-n'>df</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-n'>model</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>models</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>ECE_uniform</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ece_uniform</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>ECE_dynamic</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>ece_dynamic</span><span class='hljl-p'>,</span><span class='hljl-t'>
                   </span><span class='hljl-n'>SKCEb_median</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>skceb_median</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>SKCEuq_median</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>skceuq_median</span><span class='hljl-p'>,</span><span class='hljl-t'>
                   </span><span class='hljl-n'>SKCEul_median</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>skceul_median</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>CSV</span><span class='hljl-oB'>.</span><span class='hljl-nf'>write</span><span class='hljl-p'>(</span><span class='hljl-n'>file</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>df</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-n'>nothing</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-nf'>calibration_errors</span><span class='hljl-p'>()</span>
</pre>



<h2>Calibration tests</h2>
<p>Additionally we compute different p-value approximations for each model. More concretely, we estimate the p-value by consistency resampling of the two ECE estimators mentioned above, by distribution-free bounds of the three SKCE estimators discussed above, and by the asymptotic approximations for the unbiased quadratic and linear SKCE estimators used above. The results are saved in a CSV file <code>pvalues.csv</code>.</p>


<pre class='hljl'>
<span class='hljl-nd'>@everywhere</span><span class='hljl-t'> </span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>calibration_pvalues</span><span class='hljl-p'>(</span><span class='hljl-n'>rng</span><span class='hljl-oB'>::</span><span class='hljl-n'>AbstractRNG</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>predictions</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>labels</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>data</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>predictions</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>labels</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># evaluate consistency resampling based estimators</span><span class='hljl-t'>
    </span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-nf'>seed!</span><span class='hljl-p'>(</span><span class='hljl-n'>rng</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1234</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>ece_uniform</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'>
        </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>ConsistencyTest</span><span class='hljl-p'>(</span><span class='hljl-nf'>ECE</span><span class='hljl-p'>(</span><span class='hljl-nf'>UniformBinning</span><span class='hljl-p'>(</span><span class='hljl-ni'>10</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>rng</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>rng</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-nf'>seed!</span><span class='hljl-p'>(</span><span class='hljl-n'>rng</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1234</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>ece_dynamic</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'>
        </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>ConsistencyTest</span><span class='hljl-p'>(</span><span class='hljl-nf'>ECE</span><span class='hljl-p'>(</span><span class='hljl-nf'>MedianVarianceBinning</span><span class='hljl-p'>(</span><span class='hljl-ni'>100</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>rng</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>rng</span><span class='hljl-p'>))</span><span class='hljl-t'>

    </span><span class='hljl-cs'># compute kernel based on the median heuristic</span><span class='hljl-t'>
    </span><span class='hljl-n'>kernel</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>median_TV_kernel</span><span class='hljl-p'>(</span><span class='hljl-n'>predictions</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># evaluate distribution-free bounds</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceb_median_distribution_free</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'>
        </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>DistributionFreeTest</span><span class='hljl-p'>(</span><span class='hljl-nf'>BiasedSKCE</span><span class='hljl-p'>(</span><span class='hljl-n'>kernel</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceuq_median_distribution_free</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'>
        </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>DistributionFreeTest</span><span class='hljl-p'>(</span><span class='hljl-nf'>QuadraticUnbiasedSKCE</span><span class='hljl-p'>(</span><span class='hljl-n'>kernel</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceul_median_distribution_free</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'>
        </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>DistributionFreeTest</span><span class='hljl-p'>(</span><span class='hljl-nf'>LinearUnbiasedSKCE</span><span class='hljl-p'>(</span><span class='hljl-n'>kernel</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>))</span><span class='hljl-t'>

    </span><span class='hljl-cs'># evaluate asymptotic bounds</span><span class='hljl-t'>
    </span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-nf'>seed!</span><span class='hljl-p'>(</span><span class='hljl-n'>rng</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1234</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceuq_median_asymptotic</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'>
        </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>AsymptoticQuadraticTest</span><span class='hljl-p'>(</span><span class='hljl-n'>kernel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>rng</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>rng</span><span class='hljl-p'>))</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceul_median_asymptotic</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>pvalue</span><span class='hljl-p'>(</span><span class='hljl-nf'>AsymptoticLinearTest</span><span class='hljl-p'>(</span><span class='hljl-n'>kernel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>data</span><span class='hljl-p'>))</span><span class='hljl-t'>

    </span><span class='hljl-n'>ece_uniform</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>ece_dynamic</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>skceb_median_distribution_free</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceuq_median_distribution_free</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>skceul_median_distribution_free</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>skceuq_median_asymptotic</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>skceul_median_asymptotic</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>calibration_pvalues</span><span class='hljl-p'>()</span><span class='hljl-t'>
    </span><span class='hljl-cs'># do not recompute the p-values if a file with results exists</span><span class='hljl-t'>
    </span><span class='hljl-n'>datadir</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-nd'>@__DIR__</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;..&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;data&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;PyTorch-CIFAR10&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>file</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;pvalues.csv&quot;</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-nf'>isfile</span><span class='hljl-p'>(</span><span class='hljl-n'>file</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>&amp;&amp;</span><span class='hljl-t'> </span><span class='hljl-k'>return</span><span class='hljl-t'>

    </span><span class='hljl-cs'># load labels</span><span class='hljl-t'>
    </span><span class='hljl-n'>labels</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vec</span><span class='hljl-p'>(</span><span class='hljl-nf'>readdlm</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;labels.csv&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>Int</span><span class='hljl-p'>))</span><span class='hljl-t'>

    </span><span class='hljl-cs'># define the studied models</span><span class='hljl-t'>
    </span><span class='hljl-n'>models</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-s'>&quot;densenet121&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;densenet161&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;densenet169&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;googlenet&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;inception_v3&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
              </span><span class='hljl-s'>&quot;mobilenet_v2&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet_orig&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet18&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet34&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;resnet50&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'>
              </span><span class='hljl-s'>&quot;vgg11_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg13_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg16_bn&quot;</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;vgg19_bn&quot;</span><span class='hljl-p'>]</span><span class='hljl-t'>

    </span><span class='hljl-cs'># analyze every model</span><span class='hljl-t'>
    </span><span class='hljl-n'>wp</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>CachingPool</span><span class='hljl-p'>(</span><span class='hljl-nf'>workers</span><span class='hljl-p'>())</span><span class='hljl-t'>
    </span><span class='hljl-n'>estimates</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-k'>let</span><span class='hljl-t'> </span><span class='hljl-n'>rng</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-n'>GLOBAL_RNG</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>datadir</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>labels</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>labels</span><span class='hljl-t'>
        </span><span class='hljl-nf'>pmap</span><span class='hljl-p'>(</span><span class='hljl-n'>wp</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>models</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-k'>do</span><span class='hljl-t'> </span><span class='hljl-n'>model</span><span class='hljl-t'>
            </span><span class='hljl-cs'># load predictions</span><span class='hljl-t'>
            </span><span class='hljl-n'>predictions</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>copy</span><span class='hljl-p'>(</span><span class='hljl-nf'>readdlm</span><span class='hljl-p'>(</span><span class='hljl-nf'>joinpath</span><span class='hljl-p'>(</span><span class='hljl-n'>datadir</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;</span><span class='hljl-si'>$model</span><span class='hljl-s'>.csv&quot;</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-sc'>&#39;,&#39;</span><span class='hljl-p'>)</span><span class='hljl-oB'>&#39;</span><span class='hljl-p'>)</span><span class='hljl-t'>

            </span><span class='hljl-nd'>@info</span><span class='hljl-t'> </span><span class='hljl-s'>&quot;evaluating p-value approximations for </span><span class='hljl-si'>$model</span><span class='hljl-s'>...&quot;</span><span class='hljl-t'>
            </span><span class='hljl-n'>estimates</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>calibration_pvalues</span><span class='hljl-p'>(</span><span class='hljl-nf'>deepcopy</span><span class='hljl-p'>(</span><span class='hljl-n'>rng</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>predictions</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>labels</span><span class='hljl-p'>)</span><span class='hljl-t'>

            </span><span class='hljl-p'>(</span><span class='hljl-n'>model</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>estimates</span><span class='hljl-oB'>...</span><span class='hljl-p'>)</span><span class='hljl-t'>
        </span><span class='hljl-k'>end</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-cs'># save results</span><span class='hljl-t'>
    </span><span class='hljl-n'>df</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>DataFrame</span><span class='hljl-p'>(</span><span class='hljl-nf'>map</span><span class='hljl-p'>(</span><span class='hljl-n'>idx</span><span class='hljl-t'> </span><span class='hljl-oB'>-&gt;</span><span class='hljl-t'> </span><span class='hljl-n'>getindex</span><span class='hljl-oB'>.</span><span class='hljl-p'>(</span><span class='hljl-n'>estimates</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>idx</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>eachindex</span><span class='hljl-p'>(</span><span class='hljl-nf'>first</span><span class='hljl-p'>(</span><span class='hljl-n'>estimates</span><span class='hljl-p'>))),</span><span class='hljl-t'>
                   </span><span class='hljl-p'>[</span><span class='hljl-sc'>:model</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:ECE_uniform</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:ECE_dynamic</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:SKCEb_median_distribution_free</span><span class='hljl-p'>,</span><span class='hljl-t'>
                    </span><span class='hljl-sc'>:SKCEuq_median_distribution_free</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:SKCEul_median_distribution_free</span><span class='hljl-p'>,</span><span class='hljl-t'>
                    </span><span class='hljl-sc'>:SKCEuq_median_asymptotic</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-sc'>:SKCEul_median_asymptotic</span><span class='hljl-p'>])</span><span class='hljl-t'>
    </span><span class='hljl-n'>CSV</span><span class='hljl-oB'>.</span><span class='hljl-nf'>write</span><span class='hljl-p'>(</span><span class='hljl-n'>file</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>df</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-n'>nothing</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-nf'>calibration_pvalues</span><span class='hljl-p'>()</span>
</pre>





          <HR/>
          <div class="footer"><p>
          Published from <a href="nn.jl">nn.jl</a> using
          <a href="http://github.com/mpastell/Weave.jl">Weave.jl</a>
           on 2019-10-24.
          <p></div>


        </div>
      </div>
    </div>
  </BODY>
</HTML>
